<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insurance Register Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #e3f2fd, #ede7f6);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .form-container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      padding: 40px;
      max-width: 950px;
      width: 100%;
      animation: fadeIn 0.6s ease-in-out;
    }

    h2 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 25px;
      background: linear-gradient(to right, #00695c, #6a1b9a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #444;
    }

    .form-control, .form-select {
      border-radius: 12px;
      border: 1px solid #ccc;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #6a1b9a;
      box-shadow: 0 0 10px rgba(106, 27, 154, 0.25);
    }

    .section-title {
      margin-top: 30px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #333;
      border-left: 5px solid #6a1b9a;
      padding-left: 10px;
    }

    .btn-submit {
      background: linear-gradient(135deg, #00796b, #6a1b9a);
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      padding: 12px 30px;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background: linear-gradient(135deg, #004d40, #4a148c);
      transform: scale(1.05);
    }

    .is-invalid {
      border-color: #dc3545;
    }

    .invalid-feedback {
      color: #dc3545;
      font-size: 0.875rem;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(15px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2><i class="fa-solid fa-file-shield"></i> Insurance Register Form</h2>

    <form id="registerForm" enctype="multipart/form-data">
      <div class="row g-3">
        <!-- Branch & Full Name -->
        
        <div class="col-md-6">
          <label><i class="fa-solid fa-building"></i> Branch Name</label>
          <input type="text" class="form-control" name="BranchName" required>
          <div class="invalid-feedback">Branch Name is required.</div>
        </div>
        <div class="col-md-6">
          <label><i class="fa-solid fa-user"></i> Full Name</label>
          <input type="text" class="form-control" name="FullName" required pattern="[A-Za-z\s]{2,}">
          <div class="invalid-feedback">Full Name must be at least 2 characters long and contain only letters and spaces.</div>
        </div>

        <!-- Citizenship & NIC -->
        <div class="col-md-6">
          <label><i class="fa-solid fa-flag"></i> Citizenship</label>
          <select class="form-select" name="Citizenship" required>
            <option value="" disabled selected>Select...</option>
            <option value="Sri Lankan">Sri Lankan</option>
            <option value="Other">Other</option>
          </select>
          <div class="invalid-feedback">Citizenship is required.</div>
        </div>
        <div class="col-md-6">
          <label><i class="fa-solid fa-id-card"></i> NIC Number</label>
<input type="text" class="form-control" name="NIC" required pattern="^([0-9]{9}[xXvV]|[0-9]{12})$">
          <div class="invalid-feedback">NIC must be 9 digits followed by 'V' or 'X' or 12 digits.</div>
        </div>

        <!-- Birthday & Age -->
        <div class="col-md-6">
          <label><i class="fa-solid fa-cake-candles"></i> Birthday</label>
          <input type="date" class="form-control" id="Birthday" name="Birthday" onchange="calculateAge()" required max="2007-09-05">
          <div class="invalid-feedback">Birthday is required and must be a valid date (applicant must be at least 18).</div>
        </div>
        <div class="col-md-6">
          <label><i class="fa-solid fa-hourglass-half"></i> Age</label>
          <input type="number" class="form-control" id="Age" name="Age" readonly>
          <div class="invalid-feedback">Age must be at least 18.</div>
        </div>

        <!-- Income, Email, Children -->
        <div class="col-md-6">
          <label><i class="fa-solid fa-sack-dollar"></i> Monthly Income</label>
          <input type="number" class="form-control" name="MonthlyIncome" required min="0">
          <div class="invalid-feedback">Monthly Income must be a positive number.</div>
        </div>
        <div class="col-md-6">
          <label><i class="fa-solid fa-envelope"></i> Email Address</label>
          <input type="email" class="form-control" name="Email" required>
          <div class="invalid-feedback">A valid email address is required.</div>
        </div>
        <div class="col-md-6">
          <label><i class="fa-solid fa-children"></i> Number of Children</label>
          <input type="number" class="form-control" name="Children" min="0" value="0">
          <div class="invalid-feedback">Number of Children must be a non-negative number.</div>
        </div>

        <!-- Insurance Plan -->
        <div class="col-md-6">
          <label><i class="fa-solid fa-shield-heart"></i> Insurance Plan</label>
          <select class="form-select" name="InsurancePlan" required>
            <option value="" disabled selected>Select a Plan...</option>
            <option value="Divithilna Protection Plan">Divithilna Protection Plan</option>
            <option value="Early Cash">Early Cash</option>
            <option value="Freedom LifeStyle Plus Plan">Freedom LifeStyle Plus Plan</option>
            <option value="Janadhiri">Janadhiri</option>
            <option value="Speed Investment Plan">Speed Investment Plan</option>
            <option value="FREEDOM (Retirement Plan)">FREEDOM (Retirement Plan)</option>
            <option value="Minimuthu Parithyaga / Dayada">Minimuthu Parithyaga / Dayada</option>
            <option value="SLIC Wealth Plus">SLIC Wealth Plus</option>
            <option value="SLIC Divisavi Protection Plan">SLIC Divisavi Protection Plan</option>
            <option value="Minimuthu Dayada">Minimuthu Dayada</option>
            <option value="School Fee Protector">School Fee Protector</option>
            <option value="Swarna Dhaja">Swarna Dhaja</option>
          </select>
          <div class="invalid-feedback">Insurance Plan is required.</div>
        </div>

        <!-- Benefit -->
        <div class="col-md-6">
          <label><i class="fa-solid fa-list-check"></i> Benefit</label>
          <select class="form-select" name="Benefit" required>
            <option value="" disabled selected>Select...</option>
            <option value="Hospital Bill Cover">Hospital Bill Cover</option>
            <option value="Life Cover">Life Cover</option>
            <option value="Disability Cover">Disability Cover</option>
            <option value="Accident Cover">Accident Cover</option>
            <option value="Critical Illness Cover">Critical Illness Cover</option>
            <option value="Maternity Cover">Maternity Cover</option>
          </select>
          <div class="invalid-feedback">Benefit is required.</div>
        </div>

        <!-- Relationship -->
        <div class="col-12">
          <label class="section-title"><i class="fa-solid fa-user-friends"></i> Relationship to Insured</label>
          <div class="d-flex flex-wrap gap-3 mt-2">
            <div class="form-check"><input type="radio" class="form-check-input" name="Relationship" value="Self" required> <label class="form-check-label">Self</label></div>
            <div class="form-check"><input type="radio" class="form-check-input" name="Relationship" value="Spouse"> <label class="form-check-label">Spouse</label></div>
            <div class="form-check"><input type="radio" class="form-check-input" name="Relationship" value="Child"> <label class="form-check-label">Child</label></div>
            <div class="form-check"><input type="radio" class="form-check-input" name="Relationship" value="Parent"> <label class="form-check-label">Parent</label></div>
            <div class="form-check"><input type="radio" class="form-check-input" name="Relationship" value="Other"> <label class="form-check-label">Other</label></div>
            <div class="invalid-feedback d-block">Relationship is required.</div>
          </div>
        </div>

        <!-- Payment Details -->
        <div class="col-12">
          <label class="section-title"><i class="fa-solid fa-credit-card"></i> Payment Details</label>
        </div>
        <div class="col-md-6">
          <label>Preferred Payment Method</label>
          <select class="form-select" name="PaymentMethod" required>
            <option value="" disabled selected>Select...</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="Cheque">Cheque</option>
          </select>
          <div class="invalid-feedback">Payment Method is required.</div>
        </div>
        <div class="col-md-6">
          <label>Bank Name</label>
          <input type="text" class="form-control" name="BankName">
          <div class="invalid-feedback">Bank Name is required for Bank Transfer.</div>
        </div>
        <div class="col-md-6">
          <label>Account Holder</label>
          <input type="text" class="form-control" name="AccountHolder">
          <div class="invalid-feedback">Account Holder is required for Bank Transfer.</div>
        </div>
        <div class="col-md-6">
          <label>Account Number</label>
          <input type="text" class="form-control" name="AccountNumber" pattern="[0-9]+">
          <div class="invalid-feedback">Account Number must contain only digits and is required for Bank Transfer.</div>
        </div>

        <!-- Signature -->
        <div class="col-12">
          <label class="section-title"><i class="fa-solid fa-signature"></i> Signature</label>
        </div>
        <div class="col-md-6">
          <label>Upload Digital Signature (PNG/SVG, max 2MB)</label>
          <input type="file" class="form-control" name="Signature" accept=".png, .svg" required>
          <div class="invalid-feedback">Signature file is required (PNG/SVG, max 2MB).</div>
        </div>
        <div class="col-md-6">
          <label>Witness Name & Signature</label>
          <input type="text" class="form-control" name="Witness" required>
          <div class="invalid-feedback">Witness Name is required.</div>
        </div>
        <div class="col-md-6">
          <label>Date</label>
          <input type="date" class="form-control" name="Date" required max="2025-09-05">
          <div class="invalid-feedback">Registration Date is required and cannot be in the future.</div>
        </div>
      </div>

      <!-- Submit -->
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-submit">
          <i class="fa-solid fa-paper-plane"></i> Register
        </button>
      </div>
    </form>

    <div id="msgBox" class="mt-3"></div>
  </div>

  <script>
    function calculateAge() {
      const birthdayInput = document.getElementById("Birthday");
      const ageInput = document.getElementById("Age");
      const birthday = birthdayInput.value;
      if (birthday) {
        const birthDate = new Date(birthday);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        ageInput.value = age;
        if (age < 18) {
          ageInput.classList.add("is-invalid");
        } else {
          ageInput.classList.remove("is-invalid");
        }
      } else {
        ageInput.value = "";
      }
    }

    function validateForm() {
      const form = document.getElementById("registerForm");
      const paymentMethod = form.querySelector("[name='PaymentMethod']").value;
      const bankName = form.querySelector("[name='BankName']");
      const accountHolder = form.querySelector("[name='AccountHolder']");
      const accountNumber = form.querySelector("[name='AccountNumber']");
      const signature = form.querySelector("[name='Signature']");
      let isValid = true;

      // Bank details validation for Bank Transfer
      if (paymentMethod === "Bank Transfer") {
        if (!bankName.value.trim()) {
          bankName.classList.add("is-invalid");
          isValid = false;
        } else {
          bankName.classList.remove("is-invalid");
        }
        if (!accountHolder.value.trim()) {
          accountHolder.classList.add("is-invalid");
          isValid = false;
        } else {
          accountHolder.classList.remove("is-invalid");
        }
        if (!accountNumber.value.trim() || !/^[0-9]+$/.test(accountNumber.value)) {
          accountNumber.classList.add("is-invalid");
          isValid = false;
        } else {
          accountNumber.classList.remove("is-invalid");
        }
      } else {
        bankName.classList.remove("is-invalid");
        accountHolder.classList.remove("is-invalid");
        accountNumber.classList.remove("is-invalid");
      }

      // Signature file validation
    if (signature.files.length > 0) {
    const file = signature.files[0];
    const maxSize = 2 * 1024 * 1024; // 2MB
    if (!["image/png", "image/svg+xml"].includes(file.type) || file.size > maxSize) {
        signature.classList.add("is-invalid");
        isValid = false;
    } else {
        signature.classList.remove("is-invalid");
    }
} else {
    signature.classList.add("is-invalid");
    isValid = false;
}

      // Validate all required fields
      form.querySelectorAll("[required]").forEach(input => {
        if (!input.value.trim()) {
          input.classList.add("is-invalid");
          isValid = false;
        } else {
          input.classList.remove("is-invalid");
        }
      });

      // Validate radio buttons for Relationship
      const relationship = form.querySelector("[name='Relationship']:checked");
      const relationshipContainer = form.querySelector(".d-flex.flex-wrap");
      if (!relationship) {
        relationshipContainer.querySelector(".invalid-feedback").style.display = "block";
        isValid = false;
      } else {
        relationshipContainer.querySelector(".invalid-feedback").style.display = "none";
      }

      return isValid;
    }

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const msgBox = document.getElementById("msgBox");

      if (!validateForm()) {
        msgBox.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
          Please correct the errors in the form.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
        return;
      }

      const formData = new FormData(form);

      
      try {
        const res = await fetch("http://127.0.0.1:5000/register", {
          method: "POST",
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          msgBox.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
            ${data.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
          form.reset();
          document.getElementById("Age").value = "";
        } else {
          const errorMsg = data.error.includes("Duplicate entry") 
            ? "This NIC number is already registered."
            : data.error || "An error occurred during registration. Please try again.";
          msgBox.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
            ${errorMsg}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
        }
      } catch (err) {
        msgBox.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
          Request failed: ${err.message}. Please check your connection and try again.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>