<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
  <style>
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
    }
    h2 {
      font-weight: 700;
      margin-bottom: 20px;
    }
    table {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
    }
    .btn-custom {
      background: linear-gradient(135deg, #00796b, #6a1b9a);
      color: white;
      font-weight: 600;
      border-radius: 8px;
    }
    .btn-custom:hover {
      background: linear-gradient(135deg, #004d40, #4a148c);
      transform: scale(1.05);
    }
    .message {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="fa-solid fa-user-shield"></i> Admin Dashboard</h2>

    <!-- Users Section -->
    <h4>Users</h4>
    <button class="btn btn-custom mb-2" onclick="showUserForm()">Add User</button>
    <div id="userFormContainer" style="display:none;" class="mb-3">
      <input type="text" id="userName" placeholder="Name" class="form-control mb-2">
      <input type="email" id="userEmail" placeholder="Email" class="form-control mb-2">
      <input type="password" id="userPassword" placeholder="Password" class="form-control mb-2">
      <button class="btn btn-success" onclick="addUser()">Save</button>
      <button class="btn btn-secondary" onclick="hideUserForm()">Cancel</button>
      <div id="userFormMessage" class="message"></div>
    </div>
    <table class="table table-bordered" id="usersTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Name</th><th>Email</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Admin Section -->
    <h4 class="mt-4">Admins</h4>
    <button class="btn btn-custom mb-2" onclick="showAdminForm()">Add Admin</button>
    <div id="adminFormContainer" style="display:none;" class="mb-3">
      <input type="text" id="adminName" placeholder="Username" class="form-control mb-2">
      <input type="email" id="adminEmail" placeholder="Email" class="form-control mb-2">
      <input type="password" id="adminPassword" placeholder="Password" class="form-control mb-2">
      <button class="btn btn-success" onclick="addAdmin()">Save</button>
      <button class="btn btn-secondary" onclick="hideAdminForm()">Cancel</button>
      <div id="adminFormMessage" class="message"></div>
    </div>
    <table class="table table-bordered" id="adminsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Username</th><th>Email</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- User Predictions Section -->
    <h4 class="mt-4">User Predictions</h4>
    <table class="table table-bordered" id="predictionsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Client Name</th><th>Order Time</th><th>Order Date</th>
          <th>Total Price</th><th>Items</th><th>Created At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const token = localStorage.getItem('userToken'); // must be admin token

// -------------------- Users CRUD --------------------
function showUserForm() { document.getElementById('userFormContainer').style.display='block'; }
function hideUserForm() { document.getElementById('userFormContainer').style.display='none'; }

async function fetchUsers(){
  const res = await fetch('http://127.0.0.1:5000/get_users', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  data.forEach(u => {
    tbody.innerHTML += `<tr>
      <td>${u.id}</td>
      <td contenteditable="true" data-field="name" data-id="${u.id}">${u.name}</td>
      <td contenteditable="true" data-field="email" data-id="${u.id}">${u.email}</td>
      <td>
        <button class="btn btn-success btn-sm" onclick="updateUser(${u.id})">Update</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button>
      </td>
    </tr>`;
  });
}

async function addUser(){
  const name = document.getElementById('userName').value;
  const email = document.getElementById('userEmail').value;
  const password = document.getElementById('userPassword').value;
  const res = await fetch('http://127.0.0.1:5000/user_register', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ name, email, password })
  });
  const data = await res.json();
  document.getElementById('userFormMessage').innerHTML = data.message || data.error;
  fetchUsers();
  hideUserForm();
}

async function updateUser(id){
  const row = document.querySelector(`#usersTable td[data-id='${id}']`).parentElement;
  const name = row.querySelector("[data-field='name']").innerText;
  const email = row.querySelector("[data-field='email']").innerText;
  const res = await fetch(`http://127.0.0.1:5000/update_user/${id}`, {
    method:'PUT',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ name, email })
  });
  fetchUsers();
}

async function deleteUser(id){
  if(!confirm('Are you sure to delete user?')) return;
  await fetch(`http://127.0.0.1:5000/delete_user/${id}`, {
    method:'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  fetchUsers();
}

// -------------------- Admin CRUD --------------------
function showAdminForm() { document.getElementById('adminFormContainer').style.display='block'; }
function hideAdminForm() { document.getElementById('adminFormContainer').style.display='none'; }

async function fetchAdmins(){
  const res = await fetch('http://127.0.0.1:5000/get_admins', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  const tbody = document.querySelector('#adminsTable tbody');
  tbody.innerHTML = '';
  data.forEach(a => {
    tbody.innerHTML += `<tr>
      <td>${a.id}</td>
      <td contenteditable="true" data-field="username" data-id="${a.id}">${a.username}</td>
      <td contenteditable="true" data-field="email" data-id="${a.id}">${a.email}</td>
      <td>
        <button class="btn btn-success btn-sm" onclick="updateAdmin(${a.id})">Update</button>
        <button class="btn btn-danger btn-sm" onclick="deleteAdmin(${a.id})">Delete</button>
      </td>
    </tr>`;
  });
}

async function addAdmin(){
  const username = document.getElementById('adminName').value;
  const email = document.getElementById('adminEmail').value;
  const password = document.getElementById('adminPassword').value;
  const res = await fetch('http://127.0.0.1:5000/register', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ username, email, password })
  });
  const data = await res.json();
  document.getElementById('adminFormMessage').innerHTML = data.message || data.error;
  fetchAdmins();
  hideAdminForm();
}

async function updateAdmin(id){
  const row = document.querySelector(`#adminsTable td[data-id='${id}']`).parentElement;
  const username = row.querySelector("[data-field='username']").innerText;
  const email = row.querySelector("[data-field='email']").innerText;
  await fetch(`http://127.0.0.1:5000/update_admin/${id}`, {
    method:'PUT',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ username, email })
  });
  fetchAdmins();
}

async function deleteAdmin(id){
  if(!confirm('Are you sure to delete admin?')) return;
  await fetch(`http://127.0.0.1:5000/delete_admin/${id}`, {
    method:'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  fetchAdmins();
}

// -------------------- User Predictions --------------------
async function fetchPredictions(){
  const res = await fetch('http://127.0.0.1:5000/get_predictions', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  const tbody = document.querySelector('#predictionsTable tbody');
  tbody.innerHTML = '';
  data.forEach(p => {
    tbody.innerHTML += `<tr>
      <td>${p.id}</td>
      <td>${p.client_name}</td>
      <td>${p.order_time}</td>
      <td>${p.order_date}</td>
      <td>${p.total_price}</td>
      <td>${p.items}</td>
      <td>${p.created_at}</td>
    </tr>`;
  });
}

// -------------------- Init --------------------
fetchUsers();
fetchAdmins();
fetchPredictions();
</script>
</body>
</html>
